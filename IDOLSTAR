DOLSTAR (Idol Fan Club Dashboard) - 結合 Firebase 登入與 Firestore 存儲
  此應用程式使用 Tailwind CSS 進行設計，並在單一檔案中實現了 Firebase Authentication 和 Firestore 功能。
  
  PWA 功能已新增：
  1. Web App Manifest (動態嵌入)
  2. Service Worker (動態嵌入)
  3. iOS/Apple 啟動畫面圖示
-->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD6spXAZxteQADlg7DUwwpLZbqTm4OR5QE",
  authDomain: "idolstar-fanclub.firebaseapp.com",
  projectId: "idolstar-fanclub",
  storageBucket: "idolstar-fanclub.firebasestorage.app",
  messagingSenderId: "630308306753",
  appId: "1:630308306753:web:2f82144d918fde262f2bc0",
  measurementId: "G-83K79VTV5G"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDOLSTAR</title>

    <!-- PWA & Mobile Meta Tags Start -->
    
    <!-- 1. Web App Manifest Link (將由下面的腳本動態填入) -->
    <link rel="manifest" id="manifest-link">
    
    <!-- 2. 瀏覽器主題顏色 (配合 App 主色調) -->
    <meta name="theme-color" content="#8A2BE2">
    
    <!-- 3. iOS/Safari "新增到主畫面" 相關設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IDOLSTAR">
    
    <!-- 4. iOS 主畫面圖示 (使用佔位圖示) -->
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/FF69B4/FFFFFF?text=IDOL">
    
    <!-- PWA & Mobile Meta Tags End -->

    <!-- 載入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 設置字體為 Inter 和 Noto Sans TC -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@300;400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f7f3f8; /* 柔和的淺紫色背景 */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-pink': '#FF69B4', /* 偶像粉色 */
                        'secondary-purple': '#8A2BE2', /* 夢幻紫 */
                    },
                }
            }
        }
    </script>
    
    <!-- PWA Manifest 動態生成腳本 -->
    <script>
        // 必須動態生成 Manifest，因為我們在單一檔案中
        const manifest = {
            "name": "IDOLSTAR",
            "short_name": "IDOLSTAR",
            "start_url": "IdolFanClubDashboard.html", // 確保這與您的檔案名一致
            "display": "standalone", // 提供 App 般的體驗
            "background_color": "#f7f3f8",
            "theme_color": "#8A2BE2",
            "icons": [
                {
                    "src": "https://placehold.co/192x192/FF69B4/FFFFFF?text=IDOL",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://placehold.co/512x512/FF69B4/FFFFFF?text=IDOLSTAR",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        const manifestString = JSON.stringify(manifest);
        const blob = new Blob([manifestString], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        // 在 DOM 載入前就插入 link 標籤
        document.getElementById('manifest-link').href = manifestURL;
    </script>
</head>
<body class="min-h-screen flex flex-col">

    <!-- 導航欄 (Top Bar) -->
    <header class="sticky top-0 z-50 bg-white shadow-xl">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center py-3">
            <!-- 點擊 IDOLSTAR 標題/圖標時，導航回頁面頂部 (Home Action) -->
            <a href="#" class="flex items-center space-x-2 hover:opacity-80 transition duration-150">
                <!-- Icon and Title -->
                <svg class="w-8 h-8 text-primary-pink" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.152A1.25 1.25 0 0112 2.75V21.25a1.25 1.25 0 01-.951.598L6.46 22.51l.951-4.755A1.25 1.25 0 017.5 17.5h9a1.25 1.25 0 011.089.435l.951 4.755-4.589-.758z"></path></svg>
                <span class="text-xl font-bold text-secondary-purple">IDOLSTAR</span>
            </a>
            <div id="auth-status" class="text-sm text-gray-500 flex items-center space-x-2">
                <!-- 認證狀態將在這裡顯示 -->
            </div>
        </nav>
    </header>

    <!-- 主要內容區 -->
    <main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full">

        <!-- 1. 載入中/登入畫面 -->
        <div id="loading-view" class="flex flex-col items-center justify-center min-h-[50vh]">
            <svg class="animate-spin h-8 w-8 text-primary-pink mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-secondary-purple font-semibold">系統啟動中，正在安全登入...</p>
        </div>

        <!-- 2. 儀表板畫面 (初始隱藏) -->
        <div id="dashboard-view" class="hidden">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-6 border-b-2 border-primary-pink pb-2">
                歡迎，<span id="user-nickname" class="text-primary-pink">用戶</span>！
            </h1>

            <div class="grid md:grid-cols-2 gap-6">

                <!-- 個人檔案卡片 -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-secondary-purple">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-secondary-purple">我的追星檔案</h2>
                        <button onclick="document.getElementById('profile-modal').classList.remove('hidden')" class="text-primary-pink hover:text-pink-600 font-medium flex items-center space-x-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            <span>編輯</span>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-gray-500">我的暱稱</p>
                            <p id="profile-nickname" class="text-lg font-semibold text-gray-800">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">最喜歡的偶像</p>
                            <p id="profile-fav-idol" class="text-lg font-semibold text-primary-pink flex items-center">
                                <span class="w-3 h-3 bg-primary-pink rounded-full mr-2"></span>
                                -
                            </p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">我的 Fan Club ID</p>
                            <p id="profile-user-id" class="text-xs font-mono text-gray-600 break-all">-</p>
                        </div>
                    </div>
                </div>

                <!-- 偶像團體簡介卡片 (通用化) -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-pink">
                    <h2 class="text-xl font-bold text-primary-pink mb-4">您所追蹤的偶像</h2>
                    <p class="text-gray-700 text-sm mb-4 leading-relaxed">
                        您在「IDOLSTAR」中追蹤的偶像或團體資訊將會顯示在這裡。目前此卡片顯示的是通用模板訊息。
                    </p>
                    <p class="text-gray-500 italic text-sm">
                        此處將顯示您所追蹤偶像團體的最新成員資訊及簡介。
                    </p>
                    <button class="mt-4 text-primary-pink hover:text-pink-600 font-medium text-sm">
                        查看更多資訊 &rarr;
                    </button>
                </div>

            </div>

             <!-- 系統操作提示區 -->
            <div id="system-message-box" class="mt-8 p-4 bg-purple-100 border-l-4 border-secondary-purple text-secondary-purple rounded-lg hidden" role="alert">
                <p class="font-semibold">提示：</p>
                <p id="system-message-text" class="text-sm">系統正在加載您的個人數據...</p>
            </div>
        </div>

    </main>

    <!-- 頁尾 (Footer) -->
    <footer class="mt-auto bg-secondary-purple py-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-white text-sm">
            <p>&copy; 2025 IDOLSTAR。</p>
        </div>
    </footer>

    <!-- 個人檔案設定/編輯模態框 (Modal) -->
    <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target.id === 'profile-modal') document.getElementById('profile-modal').classList.add('hidden')">
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-secondary-purple mb-4 border-b pb-2">IDOLSTAR - 註冊/編輯</h3>
            <p class="text-gray-600 mb-6 text-sm">歡迎加入 IDOLSTAR！請設定您的追星檔案。</p>
            <form id="profile-form">
                <div class="mb-4">
                    <label for="input-nickname" class="block text-sm font-medium text-gray-700 mb-1">您的暱稱</label>
                    <input type="text" id="input-nickname" name="nickname" required placeholder="例如：星辰追光者" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-pink focus:border-primary-pink">
                </div>
                <!-- 已將下拉選單替換為手動輸入框 -->
                <div class="mb-6">
                    <label for="input-fav-idol" class="block text-sm font-medium text-gray-700 mb-1">最喜歡的偶像</label>
                    <input type="text" id="input-fav-idol" name="fav_idol" required placeholder="請自行輸入偶像的名字或團體名稱" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-pink focus:border-primary-pink">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="document.getElementById('profile-modal').classList.add('hidden')" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-full hover:bg-gray-300 transition duration-150">取消</button>
                    <button type="submit" class="px-6 py-2 bg-primary-pink text-white font-semibold rounded-full shadow-lg hover:bg-pink-600 transition duration-300">儲存變更</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PWA Service Worker 註冊腳本 -->
    <script>
        // Service Worker 註冊 (動態嵌入)
        if ('serviceWorker' in navigator) {
            // Service Worker 的程式碼本體
            const swCode = `
                const CACHE_NAME = 'idolstar-cache-v1';
                // 需要被快取的核心檔案
                const urlsToCache = [
                    'IdolFanClubDashboard.html', // 主要的 HTML 檔案
                    'https://cdn.tailwindcss.com',
                    'https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@300;400;700&display=swap',
                    'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js',
                    'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js',
                    'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js'
                ];

                // 安裝事件：開啟快取並存入核心檔案
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => {
                                console.log('Service Worker: Cache opened');
                                // 對於 CDN 資源使用 no-cors 模式
                                const requests = urlsToCache.map(url => {
                                    if (url.startsWith('http')) {
                                        return new Request(url, { mode: 'no-cors' });
                                    }
                                    return url;
                                });
                                return cache.addAll(requests);
                            }).catch(err => {
                                console.error('Service Worker: Cache install failed', err);
                            })
                    );
                });

                // 攔截網路請求
                self.addEventListener('fetch', event => {
                    // 重要：不要快取 Firebase/Google API 的動態請求 (通常是 POST)
                    if (event.request.url.includes('firebase') || event.request.url.includes('firestore') || event.request.url.includes('google')) {
                        return; // 讓瀏覽器正常處理
                    }

                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                // 1. 快取命中 (Cache Hit) - 直接回傳快取的版本
                                if (response) {
                                    return response;
                                }
                                
                                // 2. 快取未命中 (Cache Miss) - 從網路抓取
                                return fetch(event.request).then(
                                    response => {
                                        // 檢查是否為有效的回應
                                        if(!response || (response.status !== 200 && response.status !== 0) ) {
                                            return response;
                                        }

                                        // 複製一份回應，因為 request/response 只能被消耗一次
                                        const responseToCache = response.clone();

                                        caches.open(CACHE_NAME)
                                            .then(cache => {
                                                // 只快取 GET 請求
                                                if (event.request.method === 'GET') {
                                                    cache.put(event.request, responseToCache);
                                                }
                                            });

                                        return response;
                                    }
                                ).catch(err => {
                                    // 網路請求失敗 (例如離線)
                                    console.error('Service Worker: Fetch failed', err);
                                });
                            })
                    );
                });
            `;
            
            // 將字串程式碼轉換為 Blob
            const swBlob = new Blob([swCode], { type: 'application/javascript' });
            // 建立一個 URL 指向這個 Blob
            const swUrl = URL.createObjectURL(swBlob);

            // 在頁面載入完成後，註冊 Service Worker
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('ServiceWorker 註冊成功，範圍: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker 註冊失敗: ', error);
                    });
            });
        }
    </script>

    <!-- Firebase Script Start (必須在 SW 腳本之後) -->
    <script type="module">
        // 載入 Firebase SDK 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

       // 替換為您在 Firebase Console 中取得的公開設定
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "YOUR_APP_ID",
        };

        // 這是新的 appId，我們使用 firebaseConfig 內的 projectId 作為 appId
        const appId = firebaseConfig.projectId; 
        
        // 公開版本不需要 initialAuthToken，因為使用者會直接登入（例如匿名登入）
        const initialAuthToken = null;

        let db;
        let auth;
        let currentUserId = null;
        const PROFILE_COLLECTION = 'fan_profiles'; // Firestore 儲存個人檔案的 collection 名稱

        // 顯示系統提示訊息
        function showSystemMessage(message, isError = false) {
            const box = document.getElementById('system-message-box');
            const text = document.getElementById('system-message-text');
            text.textContent = message;
            box.classList.remove('hidden', 'border-secondary-purple', 'bg-purple-100', 'border-red-500', 'bg-red-100');
            if (isError) {
                box.classList.add('border-red-500', 'bg-red-100', 'text-red-700');
            } else {
                box.classList.add('border-secondary-purple', 'bg-purple-100', 'text-secondary-purple');
            }
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        // 根據使用者 ID 獲取 Firestore 文件路徑
        function getUserDocRef(userId) {
            if (!db || !userId) return null;
            // 私人數據路徑: /artifacts/{appId}/users/{userId}/fan_profiles/{userId}
            return doc(db, `artifacts/${appId}/users/${userId}/${PROFILE_COLLECTION}/${userId}`);
        }

        // 初始化 Firebase 和處理認證
        async function initFirebaseAndAuth() {
            if (!firebaseConfig) {
                showSystemMessage("錯誤：Firebase 設定遺失。", true);
                return;
            }

            try {
                // 1. 初始化 Firebase App
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // 開啟 Firestore 偵錯日誌

                document.getElementById('auth-status').textContent = '等待認證...';

                // 2. 處理認證狀態變更
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('auth-status').innerHTML = `<span class="text-secondary-purple font-medium">已登入</span> ID: <span class="text-xs font-mono">${currentUserId.substring(0, 8)}...</span>`;

                        // 顯示儀表板並隱藏載入畫面
                        document.getElementById('loading-view').classList.add('hidden');
                        document.getElementById('dashboard-view').classList.remove('hidden');
                        
                        // 3. 啟動 Firestore 即時監聽
                        setupProfileListener(currentUserId);

                        // 4. 首次登入檢查：如果沒有 profile，彈出設定框
                        const docRef = getUserDocRef(currentUserId);
                        const docSnap = await getDoc(docRef);
                        if (!docSnap.exists()) {
                            showSystemMessage("歡迎新成員！請先設定您的追星檔案。", false);
                            document.getElementById('profile-modal').classList.remove('hidden');
                        }

                  } else {
                        // 未登入，預設使用匿名登入
                        await signInAnonymously(auth);
                    }
                });

                // 確保登入過程啟動
                if (!auth.currentUser) {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                            showSystemMessage(`登入失敗: ${e.message}`, true);
                        });
                    } else {
                        await signInAnonymously(auth).catch(e => {
                            showSystemMessage(`匿名登入失敗: ${e.message}`, true);
                        });
                    }
                }


            } catch (error) {
                showSystemMessage(`Firebase 初始化錯誤: ${error.message}`, true);
                console.error("Firebase Initialization Error:", error);
            }
        }

        // 設定對使用者個人檔案的即時監聽
        function setupProfileListener(userId) {
            const docRef = getUserDocRef(userId);
            if (!docRef) return;

            // onSnapshot 會在數據變更時即時更新 UI
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updateDashboardUI(data);
                } else {
                    // 如果數據被刪除或首次加載時不存在
                    updateDashboardUI({ nickname: '未設定', fav_idol: '無' });
                }
            }, (error) => {
                showSystemMessage(`Firestore 監聽錯誤: ${error.message}`, true);
                console.error("Firestore Listener Error:", error);
            });
        }

        // 更新儀表板 UI
        function updateDashboardUI(profileData) {
            const { nickname, fav_idol } = profileData;

            document.getElementById('user-nickname').textContent = nickname || '未設定';
            document.getElementById('profile-nickname').textContent = nickname || '未設定';
            document.getElementById('profile-fav-idol').textContent = fav_idol || '無';
            document.getElementById('profile-user-id').textContent = currentUserId;

            // 預填充模態框以便編輯
            document.getElementById('input-nickname').value = nickname || '';
            document.getElementById('input-fav-idol').value = fav_idol || '';

            if (nickname && fav_idol) {
                // 如果成功加載，隱藏模態框（如果它開著）
                 document.getElementById('profile-modal').classList.add('hidden');
            }
        }

        // 儲存/更新個人檔案到 Firestore
        async function saveUserProfile(event) {
            event.preventDefault();
            if (!currentUserId) {
                showSystemMessage("錯誤：使用者尚未登入。", true);
                return;
            }

            const form = event.target;
            const nickname = form.elements['nickname'].value.trim();
            const fav_idol = form.elements['fav_idol'].value.trim(); // 使用 trim 確保手動輸入不為空

            if (!nickname || !fav_idol) {
                showSystemMessage("錯誤：暱稱和最喜歡的偶像都必須填寫。", true);
                return;
            }

            try {
                showSystemMessage("正在儲存個人檔案...");
                const docRef = getUserDocRef(currentUserId);

                const profileData = {
                    nickname: nickname,
                    fav_idol: fav_idol,
                    updatedAt: new Date().toISOString()
                };

                // setDoc 會創建或覆蓋文件
                await setDoc(docRef, profileData);
                showSystemMessage("個人檔案儲存成功！");

            } catch (error) {
                showSystemMessage(`儲存失敗: ${error.message}`, true);
                console.error("Save Profile Error:", error);
            }
        }

        // 啟動應用程式
        window.onload = () => {
            initFirebaseAndAuth();

            // 為表單綁定提交事件
            const profileForm = document.getElementById('profile-form');
            if (profileForm) {
                profileForm.addEventListener('submit', saveUserProfile);
            }
        };

    </script>
    <!-- Firebase Script End -->

</body>
</html>
